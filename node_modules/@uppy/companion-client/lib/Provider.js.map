{"version":3,"names":["RequestClient","authErrorStatusCode","isOriginAllowed","getName","id","split","map","s","charAt","toUpperCase","slice","join","getOrigin","location","origin","_refreshingTokenPromise","_classPrivateFieldLooseKey","_getAuthToken","_getPlugin","Provider","constructor","uppy","opts","Object","defineProperty","value","_getPlugin2","_getAuthToken2","writable","provider","name","pluginId","tokenKey","companionKeysParams","preAuthToken","supportsRefreshToken","headers","token","Promise","all","_classPrivateFieldLooseBase","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","removeAuthToken","removeItem","ensurePreAuth","fetchPreAuthToken","Error","authQuery","data","authUrl","_ref","authFormData","query","URLSearchParams","state","set","hostname","loginSimpleAuth","_ref2","uppyVersions","signal","post","form","qs","uppyAuthToken","loginOAuth","_ref3","throwIfAborted","link","authWindow","window","open","interval","handleMessage","resolve","reject","e","source","jsonData","err","log","companionAllowedHosts","parse","error","message","i18n","info","setInterval","closed","addEventListener","close","clearInterval","removeEventListener","login","_ref4","refreshTokenUrl","fileUrl","request","arguments","authTokenAfter","isAuthError","path","method","refreshTokenErr","undefined","res","list","directory","options","get","logout","getItem","getPlugin"],"sources":["Provider.ts"],"sourcesContent":["import type {\n  Uppy,\n  Body,\n  Meta,\n  PluginOpts,\n  UnknownProviderPlugin,\n} from '@uppy/core'\nimport type {\n  RequestOptions,\n  CompanionClientProvider,\n} from '@uppy/utils/lib/CompanionClientProvider'\nimport RequestClient, { authErrorStatusCode } from './RequestClient.js'\nimport type { CompanionPluginOptions } from './index.js'\nimport { isOriginAllowed } from './getAllowedHosts.js'\n\nexport interface Opts extends PluginOpts, CompanionPluginOptions {\n  pluginId: string\n  name?: string\n  supportsRefreshToken?: boolean\n  provider: string\n}\n\nconst getName = (id: string) => {\n  return id\n    .split('-')\n    .map((s) => s.charAt(0).toUpperCase() + s.slice(1))\n    .join(' ')\n}\n\nfunction getOrigin() {\n  // eslint-disable-next-line no-restricted-globals\n  return location.origin\n}\n\nexport default class Provider<M extends Meta, B extends Body>\n  extends RequestClient<M, B>\n  implements CompanionClientProvider\n{\n  #refreshingTokenPromise: Promise<void> | undefined\n\n  provider: string\n\n  id: string\n\n  name: string\n\n  pluginId: string\n\n  tokenKey: string\n\n  companionKeysParams?: Record<string, string>\n\n  preAuthToken: string | null\n\n  supportsRefreshToken: boolean\n\n  constructor(uppy: Uppy<M, B>, opts: Opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n    this.companionKeysParams = this.opts.companionKeysParams\n    this.preAuthToken = null\n    this.supportsRefreshToken = !!opts.supportsRefreshToken\n  }\n\n  async headers(): Promise<Record<string, string>> {\n    const [headers, token] = await Promise.all([\n      super.headers(),\n      this.#getAuthToken(),\n    ])\n    const authHeaders: Record<string, string> = {}\n    if (token) {\n      authHeaders['uppy-auth-token'] = token\n    }\n\n    if (this.companionKeysParams) {\n      authHeaders['uppy-credentials-params'] = btoa(\n        JSON.stringify({ params: this.companionKeysParams }),\n      )\n    }\n    return { ...headers, ...authHeaders }\n  }\n\n  onReceiveResponse(response: Response): Response {\n    super.onReceiveResponse(response)\n    const plugin = this.#getPlugin()\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated =\n      oldAuthenticated ?\n        response.status !== authErrorStatusCode\n      : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  async setAuthToken(token: string): Promise<void> {\n    return this.#getPlugin().storage.setItem(this.tokenKey, token)\n  }\n\n  async #getAuthToken(): Promise<string | null> {\n    return this.#getPlugin().storage.getItem(this.tokenKey)\n  }\n\n  protected async removeAuthToken(): Promise<void> {\n    return this.#getPlugin().storage.removeItem(this.tokenKey)\n  }\n\n  #getPlugin() {\n    const plugin = this.uppy.getPlugin(this.pluginId) as UnknownProviderPlugin<\n      M,\n      B\n    >\n    if (plugin == null) throw new Error('Plugin was nullish')\n    return plugin\n  }\n\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n  async ensurePreAuth(): Promise<void> {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken()\n\n      if (!this.preAuthToken) {\n        throw new Error(\n          'Could not load authentication data required for third-party login. Please try again later.',\n        )\n      }\n    }\n  }\n\n  // eslint-disable-next-line class-methods-use-this, @typescript-eslint/no-unused-vars\n  authQuery(data: unknown): Record<string, string> {\n    return {}\n  }\n\n  authUrl({\n    authFormData,\n    query,\n  }: {\n    authFormData: unknown\n    query: Record<string, string>\n  }): string {\n    const params = new URLSearchParams({\n      ...query,\n      // This is only used for Companion instances configured to accept multiple origins.\n      state: btoa(JSON.stringify({ origin: getOrigin() })),\n      ...this.authQuery({ authFormData }),\n    })\n\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken)\n    }\n\n    return `${this.hostname}/${this.id}/connect?${params}`\n  }\n\n  protected async loginSimpleAuth({\n    uppyVersions,\n    authFormData,\n    signal,\n  }: {\n    uppyVersions: string\n    authFormData: unknown\n    signal: AbortSignal\n  }): Promise<void> {\n    type Res = { uppyAuthToken: string }\n    const response = await this.post<Res>(\n      `${this.id}/simple-auth`,\n      { form: authFormData },\n      { qs: { uppyVersions }, signal },\n    )\n    this.setAuthToken(response.uppyAuthToken)\n  }\n\n  protected async loginOAuth({\n    uppyVersions,\n    authFormData,\n    signal,\n  }: {\n    uppyVersions: string\n    authFormData: unknown\n    signal: AbortSignal\n  }): Promise<void> {\n    await this.ensurePreAuth()\n\n    signal.throwIfAborted()\n\n    const link = this.authUrl({ query: { uppyVersions }, authFormData })\n    const authWindow = window.open(link, '_blank')\n    let interval: number | undefined\n    let handleMessage: ((e: MessageEvent<any>) => void) | undefined\n\n    try {\n      return await new Promise((resolve, reject) => {\n        handleMessage = (e: MessageEvent<any>) => {\n          if (e.source !== authWindow) {\n            let jsonData = ''\n            try {\n              // TODO improve our uppy logger so that it can take an arbitrary number of arguments,\n              // each either objects, errors or strings,\n              // then we donâ€™t have to manually do these things like json stringify when logging.\n              // the logger should never throw an error.\n              jsonData = JSON.stringify(e.data)\n            } catch (err) {\n              // in case JSON.stringify fails (ignored)\n            }\n            this.uppy.log(\n              `ignoring event from unknown source ${jsonData}`,\n              'warning',\n            )\n            return\n          }\n\n          const { companionAllowedHosts } = this.#getPlugin().opts\n          if (!isOriginAllowed(e.origin, companionAllowedHosts)) {\n            this.uppy.log(\n              `ignoring event from ${e.origin} vs allowed pattern ${companionAllowedHosts}`,\n              'warning',\n            )\n            // We cannot reject here because the page might send events from other origins\n            // before sending the \"real\" auth completed event.\n            // for example Box has a \"Pendo\" tool that sends events to the opener\n            // https://github.com/transloadit/uppy/pull/5719\n            return\n          }\n\n          // Check if it's a string before doing the JSON.parse to maintain support\n          // for older Companion versions that used object references\n          const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data\n\n          if (data.error) {\n            const { uppy } = this\n            const message = uppy.i18n('authAborted')\n            uppy.info({ message }, 'warning', 5000)\n            reject(new Error('auth aborted'))\n            return\n          }\n\n          if (!data.token) {\n            reject(new Error('did not receive token from auth window'))\n            return\n          }\n\n          resolve(this.setAuthToken(data.token))\n        }\n\n        // poll for user closure of the window, so we can reject when it happens\n        if (authWindow) {\n          interval = window.setInterval(() => {\n            if (authWindow.closed) {\n              reject(new Error('Auth window was closed by the user'))\n            }\n          }, 500)\n        }\n\n        signal.addEventListener('abort', () => reject(new Error('Aborted')))\n        window.addEventListener('message', handleMessage)\n      })\n    } finally {\n      // cleanup:\n      authWindow?.close()\n      window.clearInterval(interval)\n      if (handleMessage) window.removeEventListener('message', handleMessage)\n    }\n  }\n\n  async login({\n    uppyVersions,\n    authFormData,\n    signal,\n  }: {\n    uppyVersions: string\n    authFormData: unknown\n    signal: AbortSignal\n  }): Promise<void> {\n    return this.loginOAuth({ uppyVersions, authFormData, signal })\n  }\n\n  refreshTokenUrl(): string {\n    return `${this.hostname}/${this.id}/refresh-token`\n  }\n\n  fileUrl(id: string): string {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  protected async request<ResBody>(\n    ...args: Parameters<RequestClient<M, B>['request']>\n  ): Promise<ResBody> {\n    await this.#refreshingTokenPromise\n\n    try {\n      // to test simulate access token expired (leading to a token token refresh),\n      // see mockAccessTokenExpiredError in companion/drive.\n      // If you want to test refresh token *and* access token invalid, do this for example with Google Drive:\n      // While uploading, go to your google account settings,\n      // \"Third-party apps & services\", then click \"Companion\" and \"Remove access\".\n\n      return await super.request<ResBody>(...args)\n    } catch (err) {\n      if (!this.supportsRefreshToken) throw err\n      // only handle auth errors (401 from provider), and only handle them if we have a (refresh) token\n      const authTokenAfter = await this.#getAuthToken()\n      if (!err.isAuthError || !authTokenAfter) throw err\n\n      if (this.#refreshingTokenPromise == null) {\n        // Many provider requests may be starting at once, however refresh token should only be called once.\n        // Once a refresh token operation has started, we need all other request to wait for this operation (atomically)\n        this.#refreshingTokenPromise = (async () => {\n          try {\n            this.uppy.log(`[CompanionClient] Refreshing expired auth token`)\n            const response = await super.request<{ uppyAuthToken: string }>({\n              path: this.refreshTokenUrl(),\n              method: 'POST',\n            })\n            await this.setAuthToken(response.uppyAuthToken)\n          } catch (refreshTokenErr) {\n            if (refreshTokenErr.isAuthError) {\n              // if refresh-token has failed with auth error, delete token, so we don't keep trying to refresh in future\n              await this.removeAuthToken()\n            }\n            throw err\n          } finally {\n            this.#refreshingTokenPromise = undefined\n          }\n        })()\n      }\n\n      await this.#refreshingTokenPromise\n\n      // now retry the request with our new refresh token\n      return super.request(...args)\n    }\n  }\n\n  async fetchPreAuthToken(): Promise<void> {\n    if (!this.companionKeysParams) {\n      return\n    }\n\n    try {\n      const res = await this.post<{ token: string }>(`${this.id}/preauth/`, {\n        params: this.companionKeysParams,\n      })\n      this.preAuthToken = res.token\n    } catch (err) {\n      this.uppy.log(\n        `[CompanionClient] unable to fetch preAuthToken ${err}`,\n        'warning',\n      )\n    }\n  }\n\n  list<ResBody>(\n    directory: string | null,\n    options: RequestOptions,\n  ): Promise<ResBody> {\n    return this.get<ResBody>(`${this.id}/list/${directory || ''}`, options)\n  }\n\n  async logout<ResBody>(options?: RequestOptions): Promise<ResBody> {\n    const response = await this.get<ResBody>(`${this.id}/logout`, options)\n    await this.removeAuthToken()\n    return response\n  }\n}\n"],"mappings":"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","ignoreList":[]}